<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT Creator</title>
    <!-- Use Tailwind CSS for a modern, responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .gradient-button {
            background-image: linear-gradient(to right, #6EE7B7 0%, #3B82F6 51%, #6EE7B7 100%);
            background-size: 200% auto;
            transition: 0.5s;
        }
        .gradient-button:hover {
            background-position: right center; /* change the direction of the change here */
            color: #fff;
            text-decoration: none;
        }
        .container {
            max-width: 60rem; /* Use a fixed max-width for better control on large screens */
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- A simple test message -->
    <div class="fixed top-4 left-4 text-xs font-bold text-gray-400">TEST #fixed</div>

    <!-- Main Container -->
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-2xl border border-gray-200">

        <!-- Main Page Section (visible by default) -->
        <div id="main-page" class="space-y-6">
            <!-- Header Section -->
            <header class="text-center mb-8">
                <h1 class="text-4xl font-extrabold text-blue-600 mb-2">My NFT Collection</h1>
                <p class="text-gray-500">View and create your digital collectibles.</p>
            </header>

            <!-- Wallet and User Status -->
            <div class="flex justify-between items-center mb-6">
                <p id="wallet-status" class="text-sm text-gray-500 hidden"></p>
                <button id="connect-wallet-button" class="py-2 px-4 rounded-lg shadow-sm text-sm font-medium text-white gradient-button">
                    Connect Wallet
                </button>
            </div>

            <!-- Main Action Buttons -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="create-nft-button" class="py-4 px-6 rounded-lg shadow-md text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700 transition-colors duration-200">
                    Create a New NFT
                </button>
                <button class="py-4 px-6 rounded-lg shadow-md text-sm font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition-colors duration-200">
                    View My NFTs
                </button>
            </div>

            <!-- Placeholder for NFT listings -->
            <div class="mt-8 text-center text-gray-400 p-4 border border-dashed rounded-lg">
                <p>NFT listings will appear here once connected to a wallet.</p>
            </div>
        </div>

        <!-- NFT Creation Page Section (hidden by default) -->
        <div id="create-nft-page" class="space-y-6 hidden">
            <!-- Header for Creation Page -->
            <header class="mb-6 flex items-center justify-between">
                <button id="back-button" class="text-gray-500 hover:text-gray-700 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </button>
                <h2 class="text-2xl font-bold text-blue-600">Create a New NFT</h2>
                <div></div> <!-- Placeholder for alignment -->
            </header>

            <!-- NFT Creation Form -->
            <form id="nft-form" class="space-y-6">

                <!-- Image Preview Section -->
                <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">Artwork Preview</label>
                    <div class="mt-1 flex justify-center p-4 border-2 border-gray-300 border-dashed rounded-md">
                        <img src="https://raw.githubusercontent.com/UNCHAINED3D/SolarPunk-MiniGame/refs/heads/main/chicken_coop_sprite.png" alt="Chicken Coop" class="max-h-48 rounded-lg">
                    </div>
                </div>

                <!-- API Endpoint Input -->
                <div class="space-y-2">
                    <label for="api-endpoint" class="block text-sm font-medium text-gray-700">Rarible API Endpoint</label>
                    <input type="text" id="api-endpoint" name="api-endpoint" required value="https://api-dev.rarible.com/v0.1/polygon/nft/mint" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3">
                </div>

                <!-- NFT Metadata Inputs -->
                <div class="space-y-2">
                    <label for="nft-title" class="block text-sm font-medium text-gray-700">Title</label>
                    <input type="text" id="nft-title" name="nft-title" required placeholder="My Awesome NFT" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3">
                </div>

                <div class="space-y-2">
                    <label for="nft-description" class="block text-sm font-medium text-gray-700">Description</label>
                    <textarea id="nft-description" name="nft-description" rows="3" required placeholder="A brief description of your masterpiece..." class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3"></textarea>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="mint-button" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                    Mint NFT
                </button>
            </form>
        </div>

        <!-- Dynamic Message Box for Feedback -->
        <div id="message-box" class="mt-6 hidden">
            <!-- Content will be injected here -->
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const mainPage = document.getElementById('main-page');
            const createNftPage = document.getElementById('create-nft-page');
            const connectWalletButton = document.getElementById('connect-wallet-button');
            const createNftButton = document.getElementById('create-nft-button');
            const backButton = document.getElementById('back-button');
            const walletStatus = document.getElementById('wallet-status');
            const form = document.getElementById('nft-form');
            const mintButton = document.getElementById('mint-button');
            const messageBox = document.getElementById('message-box');
            const RARIBLE_API_KEY = "6a682c4d-4b3a-4cc3-99c9-591e49ab4469";
            let currentAccount = null;

            function showMainPage() {
                mainPage.classList.remove('hidden');
                createNftPage.classList.add('hidden');
            }

            function showCreatePage() {
                mainPage.classList.add('hidden');
                createNftPage.classList.remove('hidden');
                messageBox.classList.add('hidden');
            }

            createNftButton.addEventListener('click', () => {
                if (currentAccount) showCreatePage();
                else showMessage('info', 'Please connect your wallet first.');
            });

            backButton.addEventListener('click', showMainPage);

            async function connectWallet() {
                if (!window.ethereum) return showMessage('error', 'No Ethereum provider found.');

                try {
                    showMessage('info', 'Connecting to wallet...');
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    currentAccount = accounts[0];
                    walletStatus.textContent = `Connected: ${currentAccount.substring(0,6)}...${currentAccount.substring(currentAccount.length-4)}`;
                    walletStatus.classList.remove('hidden');
                    connectWalletButton.classList.add('hidden');
                    showMessage('success', 'Wallet connected!');
                } catch (err) {
                    console.error('Wallet connection error:', err);
                    showMessage('error', 'Failed to connect wallet.');
                }
            }

            connectWalletButton.addEventListener('click', connectWallet);

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentAccount) { showMessage('error','Wallet not connected'); resetFormState(); return; }

                mintButton.disabled = true;
                mintButton.textContent = 'Minting...';
                mintButton.classList.add('bg-blue-400','cursor-not-allowed');
                messageBox.classList.add('hidden');

                // We are using a static image, so no file check is needed.

                showMessage('info','Requesting wallet signature...');

                try {
                    const domain = { name:"Rarible Protocol", version:"3", chainId:80002 };
                    const types = {
                        Part:[{name:"account",type:"address"},{name:"value",type:"uint96"}],
                        Royalty:[{name:"account",type:"address"},{name:"value",type:"uint92"}],
                        MintAndTransfer:[
                            {name:"user",type:"address"},
                            {name:"creator",type:"Part"},
                            {name:"collectionId",type:"bytes32"},
                            {name:"uri",type:"string"},
                            {name:"royalties",type:"Royalty[]"},
                        ]
                    };
                    const message = {
                        user:currentAccount,
                        creator:{account:currentAccount,value:10000},
                        collectionId:"0x825b0e01701545ca4eb0d582e7188ae948701dd4",
                        uri:"https://raw.githubusercontent.com/UNCHAINED3D/SolarPunk-MiniGame/refs/heads/main/chicken_coop_sprite.png",
                        royalties:[]
                    };

                    const signature = await window.ethereum.request({
                        method:"eth_signTypedData_v4",
                        params:[currentAccount, JSON.stringify({types,domain,primaryType:"MintAndTransfer",message})]
                    });

                    showMessage('info','Signature received. Sending mint request...');

                    const mintPayload = {
                        "@type":"MINT_AND_TRANSFER",
                        collectionId:`POLYGON-AMOY:${message.collectionId}`,
                        creator:{account:`POLYGON:${currentAccount}`},
                        uri:message.uri,
                        royalties:[],
                        isTestnet:true,
                        signatures:[signature]
                    };

                    const endpoint = document.getElementById('api-endpoint').value;

                    const response = await fetch(endpoint,{
                        method:'POST',
                        headers:{
                            "Content-Type":"application/json",
                            "X-API-KEY":RARIBLE_API_KEY
                        },
                        body:JSON.stringify(mintPayload)
                    });

                    // --- DETAILED LOGGING ---
                    console.log('HTTP Status:', response.status);
                    console.log('HTTP Status Text:', response.statusText);
                    const text = await response.text();
                    console.log('Response Body:', text);

                    let mintResult;
                    try { mintResult = JSON.parse(text); } catch(err) { mintResult = text; }

                    if (!response.ok) throw new Error(text || 'Minting failed');

                    showMessage('success',`NFT Minting request submitted! Mint Result: ${JSON.stringify(mintResult)}`);

                } catch(error) {
                    console.error('Minting failed:', error);
                    showMessage('error',`Minting failed. Check console for details: ${error.message}`);
                } finally {
                    resetFormState();
                }
            });

            function resetFormState(){
                mintButton.disabled = false;
                mintButton.textContent = 'Mint NFT';
                mintButton.classList.remove('bg-blue-400','cursor-not-allowed');
            }

            function showMessage(type,message){
                messageBox.classList.remove('hidden');
                let colorClass='';
                switch(type){
                    case'success': colorClass='bg-green-100 border-green-400 text-green-700'; break;
                    case'error': colorClass='bg-red-100 border-red-400 text-red-700'; break;
                    case'info': colorClass='bg-blue-100 border-blue-400 text-blue-700'; break;
                }
                messageBox.innerHTML=`<div class="border-l-4 p-4 ${colorClass}">${message}</div>`;
            }
        });
    </script>
</body>
</html>
